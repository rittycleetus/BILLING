{% extends 'base.html' %}
{% load static %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.3/jspdf.umd.min.js"></script>
     

<style>
         .ellipsis-menu {
        position: relative;
        display: inline-block;
        cursor: pointer;
    }

    .menu-options {
        display: none;
        position: absolute;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 8px;
        z-index: 1;
        min-width: 120px;
        text-align: left;
        border-radius: 4px;
        border: 1px solid #ddd;
        top: 20px; /* Adjust the top position as needed */
        right: 0; /* Adjust the right position as needed */
    }

    .ellipsis-menu:hover .menu-options {
        display: block;
    }

    .menu-option {
        padding: 8px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .menu-option:hover {
        background-color: #f0f0f0;
    }
     .filter-box {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            z-index: 1;
           
        }
        .filter-box1 {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            z-index: 1;
            left: 850px;
        }
        .filter-box2 {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            z-index: 1;
            left: 890px;
        }

        .filter-box input,
        .filter-box select {
            margin-bottom: 5px;
        }

        .filter-btns {
            text-align: center;
        }
        .custom-button {
        background-color: #68020F;
        color: white;
        width: 50px;
    }
       td{
    border-right: 1px solid rgb(12, 12, 12);
  }
  th{
    width: 200px;
  }

  tbody:hover td:not(:last-child){
    border-right: 1px solid #68020F;
  }
  @media print {
            body {
                font-size: 12pt;
                color: black;
            }

            /* Additional print-specific styles */
            .print-header {
                font-size: 16pt;
                font-weight: bold;
                text-align: center;
                margin-bottom: 20px;
            }

            .party-name {
                font-size: 14pt;
                font-weight: bold;
                margin-bottom: 10px;
            }

            .item-details {
                margin-bottom: 20px;
            }

            /* Hide non-print elements */
            .no-print {
                display: none;
            }

        }
       
    /* Style for the popup */
    /* .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    } */
    .popup {
    display: none;
    position: absolute;
    top: 30px;
    left: 0;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    padding: 10px;
}

.share-icon {
    cursor: pointer;
}

    /* Style for the overlay */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    </style>

        </head>
        
  
<div class="body-wrapper">

    <div class="container" style="border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-top: 10px; position: relative;">
        <form style="border: 1px solid #ccc; border-radius: 8px;">


            <div class="dateclass" style="display: flex; justify-content: space-between; align-items: center; width: 800px; margin-top: 70px;">
                <div>
                    <label for="fromDate" style="margin-right: 10px;">From Date</label>
                    <input type="date" id="fromDate" name="fromDate" style="width: 380px; padding: 5px; border-radius: 4px;"  onchange="filterTable(this);updateToDateMin(this)">
                </div>
            
                <div>
                    <label for="toDate" style="margin-left: 10px;">To Date</label>
                    <input type="date" id="toDate" name="toDate" style="width: 380px; padding: 5px; border-radius: 4px;" onchange="filterTable(this);updateToDateMin(this)">
                </div>
                
            </div>
     
    <div style="display: flex;  justify-content: flex-end;">
        <a href="#" class="btn-icon" onclick="downloadExcel()"><i class="fas fa-file-excel" style="color: green; font-size: 24px; width: 50px;"></i><br>Excel</a>
        <a href="#" class="btn-icon" onclick="printPage()"><i class="fas fa-print" style="color: red; font-size: 24px; width: 50px;"></i><br>Print</a>
        <div class="share-icon" onclick="toggleSharePopup()">
            
        <i class="fas fa-share" style="color: darkblue; font-size: 24px; width: 50px;"></i><br>Share</a>
    </div>
     <!-- Popup content -->
 

<div class="popup" id="sharePopup">
    <p>Choose a platform to share:</p>
    <button onclick="shareWithCustomEmail()">
        <i class="fas fa-envelope" style="color: #4285F4;"></i>
        Gmail
    </button>
    <button onclick="shareWithWhatsApp()">
        <i class="fab fa-whatsapp" style="color: #25D366;"></i>
        WhatsApp
    </button>
    <button onclick="closePopup()">
        <i class="fas fa-times" style="color: #333;"></i>
    </button>
</div>

  <!-- Overlay to cover the background when the popup is open -->
  <div class="overlay" id="overlay"></div>

    </div>

    
     
    </div>


    <h2>Debit Note</h2>
    
    <!-- Search Column -->
    <div class="search-column" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <div style="display: flex; align-items: center;">
       
            <input type="text" id="search" name="search" placeholder="Search" style="margin-right: 10px;">
          
        </div>
        <a href="{% url 'createdebitnote' %}" class="btn btn-primary" style="background-color: maroon;"><b>+</b> Add Debit Note</a>
    </div>
          <table class="table table-hover  mt-5 " style="background-color: white;box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);"  id="debitTable">
            <thead style="background: #68020F;">
              <tr class=" text-start text-light" style="font-size: 12px;">
                <th scope="col"class="custom-width" style="border-right: 1px solid;">#</th>
                

                <th scope="col" style="border-right: 1px solid; position: relative;">
                    Date&nbsp;&nbsp;
                    <i class="fas fa-filter fa-xs" onclick="toggleFilterBoxdate(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="dateFilterBox">
                        <select id="dateFilterOption" style="width: 190px;" onchange="toggleDateInput()">
                            <option value="equalto">Equal to</option>
                            <option value="greaterthan">Greater than</option>
                            <option value="lessthan">Less than</option>
                            <option value="range">Range</option>
                        </select>
                        
                        <!-- Input field for equal to filter -->
                        <input type="date" id="equalToDateInput" placeholder="dd/mm/yy" style="width: 190px; display: none;">
                        
                        <!-- Input field for greater than filter -->
                        <input type="date" id="greaterThanDateInput" placeholder="dd/mm/yy" style="width: 190px; display: none;">
                        
                        <!-- Input field for less than filter -->
                        <input type="date" id="lessThanDateInput" placeholder="dd/mm/yy" style="width: 190px; display: none;">
                    
                        <label for="fromDateInput" style="color: black;">From:</label>
                        <input type="date" id="fromDateInput" placeholder="dd/mm/yy" style="width: 190px; display: none;"><br>
                        <label for="toDateInput"style="color: black;">To:</label>
                        <input type="date" id="toDateInput" placeholder="dd/mm/yy" style="width: 190px; display: none;">
                      
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button" id="applyButton">APPLY</button>
                        </div>
    </div>
</th>
                <th scope="col" style="border-right: 1px solid; width: 500px;">
                    Ref.No&nbsp;&nbsp;
                    <i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="refNoFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col" style="border-right: 1px solid; width: 1500px;">
                    Party Name&nbsp;&nbsp;
                    <i class="fas fa-filter fa-xs" style="color: #3498db; cursor: pointer;" onclick="toggleFilterBox1()"></i>
                    <div class="filter-box" id="partyNameFilterBox" style="width:200px">
                        <select id="optionSelect" style="width: 190px;" onchange="handleOptionChange()">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search..." id="searchInput">
                        <div class="filter-btns">
                            <button id="clearButton" onclick="clearFilter1()" class="custom-button">CLEAR</button>
                            <button id="applyButton" onclick="applyFilter1()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col" style="border-right: 1px solid;width: 1500px;">Category Name<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="categoryNameFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col"  style="border-right: 1px solid;width: 800px;">Type<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="typeFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col" style="border-right: 1px solid;width: 800px;">
                    Total
                    <i class="fas fa-filter fa-xs" onclick="toggleFilterBox('totalFilterBox')" id="totalFilterBoxIcon" style="color: #3498db;"></i>
                    <div class="filter-box" id="totalFilterBox" style="width: 200px; display: none;">
                        <select style="width: 190px;" id="totaloptions">
                            <option value="equalto">Equal to</option>
                            <option value="greaterthan">Greater than</option>
                            <option value="lessthan">Less than</option>
                        </select>
                        <input type="number" id="totalFilterValue" placeholder="Enter value">
                        <div class="filter-btns">
                            <button onclick="clearTotalFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyTotalFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                </th>
                <th scope="col" style="width: 100px; border-right: 1px solid; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Received/Paid<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="recievedFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col"  style="border-right: 1px solid;width: 500px;">Balance<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="balanceFilterBox" style="width:200px">
                        <div>
                            <select style="width: 190px;">
                                <option value="exact">Exact match</option>
                                <option value="contains">Contains</option>
                            </select>
                            <input type="text" placeholder="Search...">
                            <div class="filter-btns">
                                <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                                <button onclick="applyFilter()" class="custom-button">APPLY</button>
                            </div>
                        </div>
                    </th>
                <th scope="col"  style="border-right: 1px solid;width: 350px;">Action<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box1" id="actionFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col"  style="border-right: 1px solid;width: 400px;">By<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box2" id="byFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col"  style="border-right: 1px solid;width: 20px;"></th>
                </tr>
            </thead>
         
       
            <tbody style="font-size: 10px;font-weight: 700;">
                {% for debit in debits %}
                    <tr>
                        
                        <td>{{ forloop.counter }}</td>
                        <td>{{ debit.created_at|date:'d-m-Y' }}</td>
                        <td>{{ debit.returnno }}</td> 
                        <td class="party-name">{{ debit.party.party_name }}</td> {# Assuming 'party' is the related field in DebitNote #}
                        <td>{{ debit.category_name }}</td> 
                        <td>Debit Note</td> 
                        <td>{{ debit.grandtotal }}</td> 
                        <td>{{ debit.received_paid }}</td> 
                        <td>{{ debit.balance }}</td>
                        <td></td>
                        <td></td>
                            <!-- Add your action buttons or links here -->
                        
                        <td>
                            <div class="ellipsis-menu" id="ellipsisMenu" onclick="toggleMenu(event)">
                                <i class="fas fa-ellipsis-v"></i>
                            
                       
                            <div class="menu-options">
                                <div class="menu-option" onclick="editAction('{{ debit.id }}')">
                                    <i class="fas fa-edit" style="color: #3498db;"></i> View/Edit
                                </div>
                                <div class="menu-option" onclick="historyAction()">
                                    <i class="fas fa-history" style="color: #e67e22;"></i> History
                                </div>
                                <div class="menu-option" onclick="viewPdfAction()">
                                    <i class="fas fa-file-pdf" style="color: #27ae60;"></i> View PDF
                                </div>
                                <div class="menu-option" onclick="deleteDebitNoteItem('{{ debit.id }}')">
                                    <i class="fas fa-trash" style="color: #e74c3c;"></i> Delete
                                </div>
                                <div class="menu-option" onclick="shareAction()">
                                    <i class="fas fa-share" style="color: #9b59b6;"></i> Share
                                </div>
                                <div class="menu-option" onclick="printAction()">
                                    <i class="fas fa-print" style="color: #34495e;"></i> Print
                                </div>
                                
                            </div>
                    </div>
                </td>
                    
                    </tr>
                
                {% endfor %}
            </tbody>
            
        </table>
        <div id="noDataMessage" style="display: none; text-align: center;">
           
            <img src="{% static 'img/blank.png' %}" alt="No data image" style="height: 150px;">
            <p>No data is available for DebitNote,<br> Please try again after making relevant changes.</p>
        </div>
    <!-- Table -->
   


</div>
</form>

<div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title">Transaction or Debit Note History</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <!-- Render history details here -->
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Staff Name</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in history %}
                <tr>
                    <td>{{ item.hist_trans_date }}</td>
                    <td>{{ item.user.company.companyname }}</td>
                    <td>{{ item.action }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    </div>
</div>
 <script>
    window.onload = function() {
        // Reset date inputs to empty string
        document.getElementById('equalToDateInput').value = '';
        document.getElementById('greaterThanDateInput').value = '';
        document.getElementById('lessThanDateInput').value = '';
        document.getElementById('fromDateInput').value = '';
        document.getElementById('toDateInput').value = '';
    };

    function toggleFilterBoxdate(icon) {
    const filterBox = icon.nextElementSibling;
    // Toggle the "show" class to handle the display of the filter box
    filterBox.classList.toggle("show");

    // Toggle the display property to achieve the same effect as the original function
    filterBox.style.display = (filterBox.classList.contains("show")) ? 'block' : 'none';

    // Reset the select element to default "Equal to" option
    document.getElementById('dateFilterOption').value = 'equalto';

    // Call toggleDateInput to show/hide input fields based on the default option
    toggleDateInput();
}



    function toggleDateInput() {
        var selectedOption = document.getElementById('dateFilterOption').value;
        var equalToInput = document.getElementById('equalToDateInput');
        var greaterThanInput = document.getElementById('greaterThanDateInput');
        var lessThanInput = document.getElementById('lessThanDateInput');
        var fromDateInput = document.getElementById('fromDateInput');
        var toDateInput = document.getElementById('toDateInput');
        var fromDateLabel = document.querySelector('label[for="fromDateInput"]');
        var toDateLabel = document.querySelector('label[for="toDateInput"]');

        // Hide all input fields and labels first
        equalToInput.style.display = 'none';
        greaterThanInput.style.display = 'none';
        lessThanInput.style.display = 'none';
        fromDateInput.style.display = 'none';
        toDateInput.style.display = 'none';
        fromDateLabel.style.display = 'none';
        toDateLabel.style.display = 'none';

        // Show the input field and label corresponding to the selected option
        switch (selectedOption) {
            case 'equalto':
                equalToInput.style.display = 'block';
                break;
            case 'greaterthan':
                greaterThanInput.style.display = 'block';
                break;
            case 'lessthan':
                lessThanInput.style.display = 'block';
                break;
            case 'range':
                fromDateInput.style.display = 'block';
                toDateInput.style.display = 'block';
                fromDateLabel.style.display = 'block';
                toDateLabel.style.display = 'block';
                break;
            default:
                console.log("Invalid filter option");
        }
    }
</script>
<script>
    // Add event listener to the "Apply" button
        var applyButton = document.getElementById("applyButton");
        if (applyButton) {
            applyButton.addEventListener("click", applyFilter);
        } else {
            console.error("Element with ID 'applyButton' not found.");
        }
    

    function applyFilter(event) {
    // Prevent the default form submission behavior
    event.preventDefault();

    // Retrieve filter option and input fields
    var filterOption = document.getElementById("dateFilterOption").value;
    var equalToDateInput = document.getElementById("equalToDateInput").value;
    var greaterThanInput = document.getElementById("greaterThanDateInput").value;
    var lessThanInput = document.getElementById("lessThanDateInput").value;
    var fromDateInput = document.getElementById("fromDateInput").value;
    var toDateInput = document.getElementById("toDateInput").value;
    

    function formatDate1(date) {
        var parts = date.split('-');
        return parts[2] + '-' + parts[1] + '-' + parts[0];
    }

    // Retrieve table rows
    var tableRows = document.getElementsByTagName("tr");
        var noDataMessage = document.getElementById('noDataMessage');
        // Variable to track if any rows are visible after filtering
        var hasVisibleRows = false;
        var visibleRowCount = 0; 

        for (var i = 1; i < tableRows.length; i++) {

            var dateCell = tableRows[i].getElementsByTagName('td')[1];

            var dateFieldValue = dateCell.textContent.trim(); // Trim any leading/trailing spaces

            var rowDate = formatDate1(dateFieldValue);
            var showRow = true;

        switch (filterOption) {
            case "equalto":
                var equalToDate = new Date(equalToDateInput);

              
                var formattedRowDate = new Date(rowDate);

              
                if (formattedRowDate.getTime() !== equalToDate.getTime()) {
                    showRow = false;
                }
                break;
            case "greaterthan":
                var greaterThanDate = new Date(greaterThanInput);

                
                var formattedRowDate = new Date(rowDate);

                
                if (formattedRowDate.getTime() <= greaterThanDate.getTime()) {
                    showRow = false;
                }
                break;

            case "lessthan":
                var lessThanDate = new Date(lessThanInput);

                
                var formattedRowDate = new Date(rowDate);

                
                if (formattedRowDate.getTime() >= lessThanDate.getTime()) {
                    showRow = false;
                }
                break;
            case "range":
                var fromDate = new Date(fromDateInput);
                var toDate = new Date(toDateInput);

                
                var formattedRowDate = new Date(rowDate);

                
                if (formattedRowDate.getTime() < fromDate.getTime() || formattedRowDate.getTime() > toDate.getTime()) {
                    showRow = false;
                }
                break;
             

           

        }


        if (showRow) {
            // Increment visible row count and assign index number
            visibleRowCount++;
            tableRows[i].style.display = "";
            hasVisibleRows = true;
            // Assign index number to the first column of the visible row
            tableRows[i].getElementsByTagName('td')[0].textContent = visibleRowCount;
        } else {
            tableRows[i].style.display = "none";
        }
    }

        // Toggle the message container based on the visibility of rows
        if (!hasVisibleRows) {
            noDataMessage.style.display = "block"; // Show the message if no rows are visible
        } else {
            noDataMessage.style.display = "none"; // Hide the message if there are visible rows
        }
        // Hide the filter box after applying the filter
    var filterBox = document.getElementById('dateFilterBox');
    filterBox.style.display = 'none';
    }
    

    window.onload = function() {
    // Execute the clearFilter function when the window is loaded
    clearFilter();
};
    function clearFilter() {
    // Reset all input fields to empty string
    document.getElementById('equalToDateInput').value = '';
    document.getElementById('greaterThanDateInput').value = '';
    document.getElementById('lessThanDateInput').value = '';
    document.getElementById('fromDateInput').value = '';
    document.getElementById('toDateInput').value = '';

    // Reset the select element to default "Equal to" option
    document.getElementById('dateFilterOption').value = 'equalto';

    // Hide all table rows
    var tableRows = document.getElementsByTagName("tr");
    for (var i = 1; i < tableRows.length; i++) {
        tableRows[i].style.display = "";
    }

    // Hide the no data message
    var noDataMessage = document.getElementById('noDataMessage');
    noDataMessage.style.display = "none";

    // Remove filter settings from localStorage
    localStorage.removeItem('totalFilterOption');
    localStorage.removeItem('totalFilterValue');
}

// Check for stored filter settings upon DOMContentLoaded
document.addEventListener('DOMContentLoaded', function () {
    // Retrieve filter settings from localStorage
    var filterOption = localStorage.getItem('totalFilterOption');
    var filterValue = localStorage.getItem('totalFilterValue');
    
    if (filterOption && filterValue) {
        // Set the filter option and value
        document.getElementById('totaloptions').value = filterOption;
        document.getElementById('totalFilterValue').value = filterValue;
        
        // Apply the filter
        applyTotalFilter();
    }
});
</script>
  







<!-- PARTY NAME FILTER -->
  <script>
document.addEventListener('DOMContentLoaded', function () {
    // Retrieve filter settings from localStorage
    var option = localStorage.getItem('filterOption');
    var searchText = localStorage.getItem('filterText');
    if (option && searchText) {
        document.getElementById('optionSelect').value = option;
        document.getElementById('searchInput').value = searchText;
        applyFilter1();
    }
});

function handleOptionChange() {
    // Handle option change if needed
}

function clearFilter1() {
    document.getElementById('searchInput').value = '';
    applyFilter1();
}

function applyFilter1() {
    var option = document.getElementById('optionSelect').value;
    var searchText = document.getElementById('searchInput').value.toLowerCase();
    var rows = document.querySelectorAll('.party-name');
    var visibleRowCount1 = 0; 

    rows.forEach(function(row, index) {
        var rowText = row.textContent.toLowerCase();
        var displayStyle = 'none'; // Default display style
        if (option === 'exact') {
            if (rowText === searchText) {
                displayStyle = 'table-row';
            }
        } else if (option === 'contains') {
            if (rowText.includes(searchText)) {
                displayStyle = 'table-row';
            }
        }
        row.closest('tr').style.display = displayStyle;
        if (displayStyle === 'table-row') {
            visibleRowCount1++;
            row.closest('tr').getElementsByTagName('td')[0].textContent = visibleRowCount1;
        }
    });

    // Check if there are any visible rows
    var noDataMessage = document.getElementById('noDataMessage');
    var visibleRows = document.querySelectorAll('tbody tr[style="display: table-row;"]');
    if (visibleRows.length === 0) {
        noDataMessage.style.display = "block"; // Show the message if no rows are visible
    } else {
        noDataMessage.style.display = "none"; // Hide the message if there are visible rows
    }

    // Store filter settings in localStorage
    localStorage.setItem('filterOption', option);
    localStorage.setItem('filterText', searchText);
}


function toggleFilterBox1() {
    var filterBox = document.getElementById('partyNameFilterBox');
    if (filterBox.style.display === 'none' || filterBox.style.display === '') {
        filterBox.style.display = 'block';
    } else {
        filterBox.style.display = 'none';
    }
}
</script>






<!-- TOTAL FILTER -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
    // Retrieve filter settings from localStorage
    var filterOption = localStorage.getItem('totalFilterOption');
    var filterValue = localStorage.getItem('totalFilterValue');
    
    if (filterOption && filterValue) {
        // Set the filter option and value
        document.getElementById('totaloptions').value = filterOption;
        document.getElementById('totalFilterValue').value = filterValue;
        
        // Apply the filter
        applyTotalFilter();
    }
});

    function toggleFilterBox(totalFilterBoxIcon) {
    var filterBox = document.getElementById(totalFilterBoxIcon);
    filterBox.style.display = (filterBox.style.display === 'none' || filterBox.style.display === '') ? 'block' : 'none';
}
function applyTotalFilter() {
    // Retrieve selected option and input fields
    var filterOption = document.getElementById("totaloptions").value;
    var filterValue = parseFloat(document.getElementById("totalFilterValue").value); // Assuming input field ID is "totalFilterValue"

    // Get all the table rows
    var tableRows = document.getElementsByTagName("tr");

    // Initialize a variable to track if any rows are visible after filtering
    var hasVisibleRows = false;

    // Initialize a variable to track the visible row count for updating index numbers
    var visibleRowCount = 0;

    // Loop through each row (skipping the header row)
    for (var i = 1; i < tableRows.length; i++) {
        var totalCell = tableRows[i].getElementsByTagName('td')[6]; // Assuming total column is the 7th column (index 6)
        var totalValue = parseFloat(totalCell.textContent.trim()); // Parse total value as float

        // Apply filter based on the selected option
        switch (filterOption) {
            case "equalto":
                if (totalValue !== filterValue) {
                    tableRows[i].style.display = 'none';
                } else {
                    tableRows[i].style.display = '';
                    hasVisibleRows = true;
                    visibleRowCount++;
                }
                break;
            case "greaterthan":
                if (totalValue <= filterValue) {
                    tableRows[i].style.display = 'none';
                } else {
                    tableRows[i].style.display = '';
                    hasVisibleRows = true;
                    visibleRowCount++;
                }
                break;
            case "lessthan":
                if (totalValue >= filterValue) {
                    tableRows[i].style.display = 'none';
                } else {
                    tableRows[i].style.display = '';
                    hasVisibleRows = true;
                    visibleRowCount++;
                }
                break;
        }

        // Update the index number for visible rows
        if (tableRows[i].style.display !== 'none') {
            tableRows[i].getElementsByTagName('td')[0].textContent = visibleRowCount;
        }
    }

    // Toggle the "No Data" message based on the visibility of rows
    var noDataMessage = document.getElementById('noDataMessage');
    if (!hasVisibleRows) {
        noDataMessage.style.display = "block"; // Show the message if no rows are visible
    } else {
        noDataMessage.style.display = "none"; // Hide the message if there are visible rows
    }
    
    // Store filter settings in localStorage
    localStorage.setItem('totalFilterOption', filterOption);
    localStorage.setItem('totalFilterValue', filterValue);
}
function clearTotalFilter() {
    // Clear any input fields and reset the filter settings
    document.getElementById('totaloptions').value = 'equalto';
    document.getElementById('totalFilterValue').value = ''; // Assuming input field ID is "totalFilterValue"

    // Reset the display of table rows to show all rows
    var tableRows = document.getElementsByTagName("tr");
    for (var i = 1; i < tableRows.length; i++) {
        tableRows[i].style.display = '';
    }

    // Hide the filter box
    document.getElementById('totalFilterBox').style.display = 'none';

    // Clear filter settings from localStorage
    localStorage.removeItem('totalFilterOption');
    localStorage.removeItem('totalFilterValue');

 
}
    </script>
<script>
function printPage() {
    // Open a new window for printing
    var printWindow = window.open('', '_blank');

    // Sample content for demonstration
    var companyName = "ABC Company";
    var partyName = "Party XYZ";
    var phoneNumber = "123-456-7890";
    var debitNoteNumber = "DN123";
    var debitNoteDate = "2022-02-01";
    var returnTo = "Return To: ABC Company";
    var shipTo = "Ship To: Address XYZ";
    var returnNo = "Return No: RN456";
    var returnDate = "2022-02-05";

    // Sample table data
    var tableData = `
        <table border="1" cellspacing="0" cellpadding="5" width="100%">
            <thead>
                <tr style="background-color:blue;">
                    <th>#</th>
                    <th>Items</th>
                    <th>HSN</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Tax</th>
                    <th>Discount</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td>Item A</td>
                    <td>12345</td>
                    <td>$50.00</td>
                    <td>2</td>
                    <td>$5.00</td>
                    <td>$10.00</td>
                    <td>$90.00</td>
                </tr>
                <!-- Add more rows as needed -->
            </tbody>
        </table>
    `;

    // Sample summary data
    var summaryData = `
        <div style="text-align: right; margin-top: 10px;">
            <p>Subtotal: $140.00</p>
            <p>Tax Amount: $10.00</p>
            <p>Adjustment: -$5.00</p>
            <p>Grand Total: $145.00</p>
        </div>
    `;

    // Set the content of the new window
    var content = `
        <div style="margin-bottom: 20px;">
            <div style="float: left;">
                <h2>${partyName}</h2>
                <p>${phoneNumber}</p>
            </div>
            <div style="text-align: center;">
                <h1 style="color: blue;">DEBIT NOTE</h1>
                <p style=>${returnTo}</p>
                <p style=>${shipTo}</p>
                <p style="text-align: right;">Debit No: ${debitNoteNumber} - Debit Date: ${debitNoteDate}</p>
            </div>
        </div>
        
        <h2>${companyName}</h2>
        
        ${tableData}

        ${summaryData}
    `;

    printWindow.document.write(content);

    // Trigger the print function
    printWindow.print();
}

</script>
<script>
    function downloadExcel() {
        // Your Excel content (replace this with the actual content)
        var excelContent = `
            <table>
                <tr>
                    <td>Cell 1</td>
                    <td>Cell 2</td>
                </tr>
                <tr>
                    <td>Cell 3</td>
                    <td>Cell 4</td>
                </tr>
            </table>
        `;

        // Convert the content to a Blob
        var blob = new Blob([excelContent], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

        // Create a download link
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'your_excel_file.xls'; // Specify the file name

        // Append the link to the document
        document.body.appendChild(link);

        // Trigger the click event on the link
        link.click();

        // Remove the link from the document
        document.body.removeChild(link);
    }
</script>
 
  <script>
    // Function to show the popup
    function toggleSharePopup() {
    var sharePopup = document.getElementById('sharePopup');
    sharePopup.style.display = (sharePopup.style.display === 'none' || sharePopup.style.display === '') ? 'block' : 'none';
}

  

    function shareWithCustomEmail() {
    // Prompt for email address
    var to = prompt("Enter recipient's email address:");

    if (to === null) {
        // User clicked Cancel
        return;
    }

    // Prompt for subject
    var subject = "Your Debit Note invoice details";

    // Prompt for message
    var message = `Dear,\nThanks for doing business with us. Below are your invoice details.\nAmount: 336\nBalance: 336\nTotal Balance: -2352\n\nThanks & Regards`;

    // Create the mailto link
    var mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;

    // Opening the link in a new tab
    window.open(mailtoLink, '_blank');
}


function shareWithWhatsApp() {
  // Add your logic for sharing with WhatsApp here

  // Replace '1234567890' with the recipient's phone number (include the country code)
  var phoneNumber = '1234567890';

  // Replace 'Hello, this is the message!' with your predefined message
  var message = encodeURIComponent('Hello, this is the message!');

  // Creating the WhatsApp link
  var whatsappLink = `https://wa.me/${phoneNumber}?text=${message}`;

  // Opening the link in a new tab
  window.open(whatsappLink, '_blank');
}


    function closePopup() {
    var sharePopup = document.getElementById('sharePopup');
    sharePopup.style.display = 'none';
}
  </script>

<script>
    
    // Define a function to clear the "To Date" input field
    function clearToDateInput() {
        document.getElementById("toDate").value = "";
        document.getElementById("fromDate").value = "";
    }

    // Attach the clearToDateInput function to the window.onload event
    window.onload = function() {
        clearToDateInput(); // Call the function to clear the "To Date" input field when the page loads
    };
      // Function to update the minimum date for the "To Date" input field based on the selected "From Date"
     
      function updateToDateMin() {
    var fromDateValue = document.getElementById("fromDate").value;
    document.getElementById("toDate").min = fromDateValue;

    // If "From Date" is cleared, clear the "To Date" input field
    if (!fromDateValue) {
        clearToDateInput();
    }
}

// Function to filter the table based on the selected date range
function filterTable() {
    var fromDate = document.getElementById('fromDate').value;
    var toDate = document.getElementById('toDate').value;
    
    // Function to convert date format from "YY-mm-dd" to "dd-mm-yy"
    function formatDate(date) {
        var parts = date.split('-');
        return parts[2] + '-' + parts[1] + '-' + parts[0];
    }

    // Get all the table rows
    var table = document.getElementById('debitTable');
    var rows = table.getElementsByTagName('tr');
    
    var noDataMessage = document.getElementById('noDataMessage'); // Get the message container
    
    // Initialize a variable to track if any rows are visible after filtering
    var hasVisibleRows = false;
    
    // Loop through each row (skipping the header row)
    for (var i = 1; i < rows.length; i++) {
        var dateCell = rows[i].getElementsByTagName('td')[1]; // Assuming date is in the second column
        var dateValue = dateCell.textContent.trim();
        
        // Convert date format from "dd-mm-yy" to "YY-mm-dd"
        var formattedDateValue = formatDate(dateValue);

        // Check if the row date falls within the selected date range
        if (fromDate && toDate && formattedDateValue >= fromDate && formattedDateValue <= toDate) {
            // If the row date falls within the range, display the row
            rows[i].style.display = '';
            hasVisibleRows = true; // Set to true if any row is visible
        } else {
            // Otherwise, hide the row
            rows[i].style.display = 'none';
        }
    }
    
    // Toggle the message container based on the visibility of rows
    if (!hasVisibleRows) {
        noDataMessage.style.display = 'block'; // Show the message container
    } else {
        noDataMessage.style.display = 'none'; // Hide the message container
    }
}
</script>

<script>
    document.getElementById('ellipsisMenu').addEventListener('click', function (event) {
        const ellipsisIcon = event.target.closest('.ellipsis-menu i');
        if (ellipsisIcon) {
            const menuOptions = ellipsisIcon.nextElementSibling;
            menuOptions.style.display = (menuOptions.style.display === 'none' || menuOptions.style.display === '') ? 'block' : 'none';
        }
    });

    document.addEventListener('click', function (event) {
        const ellipsisMenu = document.getElementById('ellipsisMenu');
        if (!ellipsisMenu.contains(event.target)) {
            // Hide menu if click is outside the ellipsis menu
            document.querySelector('.menu-options').style.display = 'none';
        }
    });

    document.querySelector('.menu-options').addEventListener('click', function (event) {
        const menuOption = event.target.closest('.menu-option');
        if (menuOption) {
            const action = menuOption.getAttribute('data-action');
            handleAction(action);
            // Hide menu after an option is clicked
            this.style.display = 'none';
        }
    });

    function handleAction(action) {
        switch (action) {
            case 'view':
                viewAction();
                break;
            case 'edit':
                editAction();
                break;
            case 'history':
                historyAction();
                break;
            case 'viewPdf':
                viewPdfAction();
                break;
            case 'delete':
                deleteAction();
                break;
        }
    }

    function viewAction() {
        console.log('View action triggered');
    }

   


    function editAction(debitnote_id) {
        // Redirect to the edit debit note page with the debitnote_id as a parameter
        window.location.href = `/edit_debit_note/${debitnote_id}`;
    }

    function historyAction() {
        console.log('History action triggered');
    }

    function viewPdfAction() {
    // Create a new jsPDF instance
    var doc = new jsPDF();

    // Set properties for the PDF document
    doc.setProperties({
        title: 'Table Data PDF',
        subject: 'Details of table rows',
        author: 'Your Name',
        keywords: 'PDF, table, details',
        creator: 'Your Application'
    });

    // Initialize variables for positioning and page size
    var startY = 10;
    var pageHeight = doc.internal.pageSize.height;

    // Loop through each row in the table
    document.querySelectorAll('tbody tr').forEach(function(row, index) {
        // Get data from each cell in the row
        var rowData = [];
        row.querySelectorAll('td').forEach(function(cell) {
            rowData.push(cell.textContent.trim());
        });

        // Check if the current row will fit on the current page
        if (startY + 10 > pageHeight) {
            // Add a new page if the current row won't fit
            doc.addPage();
            startY = 10; // Reset startY for the new page
        }

        // Add the row data to the PDF document
        doc.text(10, startY, rowData.join(', '));

        // Increment startY for the next row
        startY += 10;
    });

    // Save the PDF document
    doc.save('table_data.pdf');
}

   
</script>
<script>
    function toggleMenu(event) {
    var menu = event.currentTarget.querySelector('.menu-options');
    menu.classList.toggle('show-menu');

    // Check if menu is overflowing
    var overflowRight = menu.getBoundingClientRect().right > window.innerWidth;
    var overflowBottom = menu.getBoundingClientRect().bottom > window.innerHeight;

    if (overflowRight) {
        menu.style.left = 'auto';
        menu.style.right = '0';
    }

    if (overflowBottom) {
        menu.style.top = 'auto';
        menu.style.bottom = '0';
    }
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
    var menu = document.getElementById('ellipsisMenu').querySelector('.menu-options');
    if (!event.target.closest('.ellipsis-menu')) {
        menu.classList.remove('show-menu');
    }
});

    function deleteDebitNoteItem(debitnoteId) {
        if (confirm('Are you sure you want to delete this debit note item?')) {
            fetch(`/delete_debit_note_item/${debitnoteId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    // Refresh the page or update UI as needed
                    location.reload();
                } else {
                    alert('Failed to delete debit note item');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }
  
    function historyAction() {
        // Make an AJAX request to fetch history details
        $.ajax({
            url: '/get_history/',  // URL to your Django view
            type: 'GET',
            data: {
                'debitnote_id': '{{ debit.id }}',  // Pass debit note id to fetch its history
            },
            success: function(data) {
                // Render the fetched data in a modal popup
                $('#historyModal .modal-body').html(data);
                $('#historyModal').modal('show');
            },
            error: function(xhr, status, error) {
                // Handle error
                console.error(xhr.responseText);
            }
        });
    }
</script>
</div>
{% endblock %}