{% extends 'base.html' %}
{% load static %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
     

<style>
         .ellipsis-menu {
        position: relative;
        display: inline-block;
        cursor: pointer;
    }

    .menu-options {
        display: none;
        position: absolute;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 8px;
        z-index: 1;
        min-width: 120px;
        text-align: left;
        border-radius: 4px;
        border: 1px solid #ddd;
        top: 20px; /* Adjust the top position as needed */
        right: 0; /* Adjust the right position as needed */
    }

    .ellipsis-menu:hover .menu-options {
        display: block;
    }

    .menu-option {
        padding: 8px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .menu-option:hover {
        background-color: #f0f0f0;
    }
     .filter-box {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            z-index: 1;
           
        }
        .filter-box1 {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            z-index: 1;
            left: 850px;
        }
        .filter-box2 {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            z-index: 1;
            left: 890px;
        }

        .filter-box input,
        .filter-box select {
            margin-bottom: 5px;
        }

        .filter-btns {
            text-align: center;
        }
        .custom-button {
        background-color: #68020F;
        color: white;
        width: 50px;
    }
       td{
    border-right: 1px solid rgb(12, 12, 12);
  }
  th{
    width: 200px;
  }

  tbody:hover td:not(:last-child){
    border-right: 1px solid #68020F;
  }
  @media print {
            body {
                font-size: 12pt;
                color: black;
            }

            /* Additional print-specific styles */
            .print-header {
                font-size: 16pt;
                font-weight: bold;
                text-align: center;
                margin-bottom: 20px;
            }

            .party-name {
                font-size: 14pt;
                font-weight: bold;
                margin-bottom: 10px;
            }

            .item-details {
                margin-bottom: 20px;
            }

            /* Hide non-print elements */
            .no-print {
                display: none;
            }

        }
       
    /* Style for the popup */
    /* .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    } */
    .popup {
    display: none;
    position: absolute;
    top: 30px;
    left: 0;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    padding: 10px;
}

.share-icon {
    cursor: pointer;
}

    /* Style for the overlay */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    </style>

        </head>
<div class="body-wrapper">

    <div class="container" style="border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-top: 10px; position: relative;">
        <form style="border: 1px solid #ccc; border-radius: 8px;">


            <div class="dateclass" style="display: flex; justify-content: space-between; align-items: center; width: 800px; margin-top: 70px;">
                <div>
                    <label for="fromDate" style="margin-right: 10px;">From Date</label>
                    <input type="date" id="fromDate" name="fromDate" style="width: 380px; padding: 5px; border-radius: 4px;" onchange="updateToDateMin()">
                </div>
            
                <div>
                    <label for="toDate" style="margin-left: 10px;">To Date</label>
                    <input type="date" id="toDate" name="toDate" style="width: 380px; padding: 5px; border-radius: 4px;">
                </div>
            </div>
     
    <div style="display: flex;  justify-content: flex-end;">
        <a href="#" class="btn-icon" onclick="downloadExcel()"><i class="fas fa-file-excel" style="color: green; font-size: 24px; width: 50px;"></i><br>Excel</a>
        <a href="#" class="btn-icon" onclick="printPage()"><i class="fas fa-print" style="color: red; font-size: 24px; width: 50px;"></i><br>Print</a>
        <div class="share-icon" onclick="toggleSharePopup()">
            
        <i class="fas fa-share" style="color: darkblue; font-size: 24px; width: 50px;"></i><br>Share</a>
    </div>
     <!-- Popup content -->
 

<div class="popup" id="sharePopup">
    <p>Choose a platform to share:</p>
    <button onclick="shareWithCustomEmail()">
        <i class="fas fa-envelope" style="color: #4285F4;"></i>
        Gmail
    </button>
    <button onclick="shareWithWhatsApp()">
        <i class="fab fa-whatsapp" style="color: #25D366;"></i>
        WhatsApp
    </button>
    <button onclick="closePopup()">
        <i class="fas fa-times" style="color: #333;"></i>
    </button>
</div>

  <!-- Overlay to cover the background when the popup is open -->
  <div class="overlay" id="overlay"></div>

    </div>

    
     
    </div>


    <h2>Debit Note</h2>
    
    <!-- Search Column -->
    <div class="search-column" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <div style="display: flex; align-items: center;">
       
            <input type="text" id="search" name="search" placeholder="Search" style="margin-right: 10px;">
          
        </div>
        <a href="{% url 'createdebitnote' %}" class="btn btn-primary" style="background-color: maroon;"><b>+</b> Add Debit Note</a>
    </div>
   
        <table class="table table-hover  mt-5 " style="background-color: white;box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
            <thead style="background: #68020F;">
              <tr class=" text-start text-light" style="font-size: 12px;">
                <th scope="col"class="custom-width" style="border-right: 1px solid;">#</th>
                <th scope="col" style="border-right: 1px solid; position: relative;">
                    Date
                    <i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="dateFilterBox" >
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col" style="border-right: 1px solid; width: 500px;">
                    Ref.No&nbsp;&nbsp;
                    <i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="refNoFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col" style="border-right: 1px solid; width: 1500px;">
                    Party Name&nbsp;&nbsp;
                    <i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="partyNameFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col" style="border-right: 1px solid;width: 1500px;">Category Name<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="categoryNameFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col"  style="border-right: 1px solid;width: 800px;">Type<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="typeFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col"style="border-right: 1px solid;width: 800px;">Total<i class="fas fa-filter fa-xs"onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="totalFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col"  style="width: 1300px; border-right: 1px solid;">Received/Paid<i class="fas fa-filter fa-xs"onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="recievedFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col"  style="border-right: 1px solid;width: 500px;">Balance<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box" id="balanceFilterBox" style="width:200px">
                        <div>
                            <select style="width: 190px;">
                                <option value="exact">Exact match</option>
                                <option value="contains">Contains</option>
                            </select>
                            <input type="text" placeholder="Search...">
                            <div class="filter-btns">
                                <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                                <button onclick="applyFilter()" class="custom-button">APPLY</button>
                            </div>
                        </div>
                    </th>
                <th scope="col"  style="border-right: 1px solid;width: 350px;">Action<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box1" id="actionFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col"  style="border-right: 1px solid;width: 400px;">By<i class="fas fa-filter fa-xs" onclick="toggleFilterBox(this)" style="color: #3498db;"></i>
                    <div class="filter-box2" id="byFilterBox" style="width:200px">
                        <select style="width: 190px;">
                            <option value="exact">Exact match</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input type="text" placeholder="Search...">
                        <div class="filter-btns">
                            <button onclick="clearFilter()" class="custom-button">CLEAR</button>
                            <button onclick="applyFilter()" class="custom-button">APPLY</button>
                        </div>
                    </div>
                </th>
                <th scope="col"  style="border-right: 1px solid;width: 20px;"></th>
                </tr>
            </thead>
         
       
            <tbody>
                {% for debit in debits %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ debit.created_at|date:'Y-m-d' }}</td>
                        <td>{{ debit.returnno }}</td> 
                        <td>{{ debit.party.party_name }}</td>  {# Assuming 'party' is the related field in DebitNote #}
                        <td>{{ debit.category_name }}</td> 
                        <td>Debit Note</td> 
                        <td>{{ debit.grandtotal }}</td> 
                        <td>{{ debit.received_paid }}</td> 
                        <td>{{ debit.balance }}</td>
                        <td>
                            <!-- Add your action buttons or links here -->
                        
                        <td>
                        <div class="ellipsis-menu" id="ellipsisMenu">
                            <i class="fas fa-ellipsis-v"></i>
                       
                            <div class="menu-options">
                                <div class="menu-option" onclick="editAction()">
                                    <i class="fas fa-edit" style="color: #3498db;"></i> View/Edit
                                </div>
                                <div class="menu-option" onclick="historyAction()">
                                    <i class="fas fa-history" style="color: #e67e22;"></i> History
                                </div>
                                <div class="menu-option" onclick="viewPdfAction()">
                                    <i class="fas fa-file-pdf" style="color: #27ae60;"></i> View PDF
                                </div>
                                <div class="menu-option"  onclick="deleteAction('{{ debit.id }}')">
                                    <i class="fas fa-trash" style="color: #e74c3c;"></i> Delete
                                </div>
                            </div>
                    </div>
                </td>
                    
                    </tr>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    <!-- Table -->
   


</div>
</form>
<!-- Additional HTML content -->
<script>
    function toggleFilterBox(icon) {
        const filterBox = icon.nextElementSibling;
        filterBox.style.display = (filterBox.style.display === 'none' || filterBox.style.display === '') ? 'block' : 'none';
    }

    function clearFilter() {
        // Implement logic to clear the filter
        console.log('Clearing filter...');
    }

    function applyFilter() {
        // Implement logic to apply the filter
        console.log('Applying filter...');
    }
</script>

<script>
function printPage() {
    // Open a new window for printing
    var printWindow = window.open('', '_blank');

    // Sample content for demonstration
    var companyName = "ABC Company";
    var partyName = "Party XYZ";
    var phoneNumber = "123-456-7890";
    var debitNoteNumber = "DN123";
    var debitNoteDate = "2022-02-01";
    var returnTo = "Return To: ABC Company";
    var shipTo = "Ship To: Address XYZ";
    var returnNo = "Return No: RN456";
    var returnDate = "2022-02-05";

    // Sample table data
    var tableData = `
        <table border="1" cellspacing="0" cellpadding="5" width="100%">
            <thead>
                <tr style="background-color:blue;">
                    <th>#</th>
                    <th>Items</th>
                    <th>HSN</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Tax</th>
                    <th>Discount</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td>Item A</td>
                    <td>12345</td>
                    <td>$50.00</td>
                    <td>2</td>
                    <td>$5.00</td>
                    <td>$10.00</td>
                    <td>$90.00</td>
                </tr>
                <!-- Add more rows as needed -->
            </tbody>
        </table>
    `;

    // Sample summary data
    var summaryData = `
        <div style="text-align: right; margin-top: 10px;">
            <p>Subtotal: $140.00</p>
            <p>Tax Amount: $10.00</p>
            <p>Adjustment: -$5.00</p>
            <p>Grand Total: $145.00</p>
        </div>
    `;

    // Set the content of the new window
    var content = `
        <div style="margin-bottom: 20px;">
            <div style="float: left;">
                <h2>${partyName}</h2>
                <p>${phoneNumber}</p>
            </div>
            <div style="text-align: center;">
                <h1 style="color: blue;">DEBIT NOTE</h1>
                <p style=>${returnTo}</p>
                <p style=>${shipTo}</p>
                <p style="text-align: right;">Debit No: ${debitNoteNumber} - Debit Date: ${debitNoteDate}</p>
            </div>
        </div>
        
        <h2>${companyName}</h2>
        
        ${tableData}

        ${summaryData}
    `;

    printWindow.document.write(content);

    // Trigger the print function
    printWindow.print();
}

</script>
<script>
    function downloadExcel() {
        // Your Excel content (replace this with the actual content)
        var excelContent = `
            <table>
                <tr>
                    <td>Cell 1</td>
                    <td>Cell 2</td>
                </tr>
                <tr>
                    <td>Cell 3</td>
                    <td>Cell 4</td>
                </tr>
            </table>
        `;

        // Convert the content to a Blob
        var blob = new Blob([excelContent], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

        // Create a download link
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'your_excel_file.xls'; // Specify the file name

        // Append the link to the document
        document.body.appendChild(link);

        // Trigger the click event on the link
        link.click();

        // Remove the link from the document
        document.body.removeChild(link);
    }
</script>
 
  <script>
    // Function to show the popup
    function toggleSharePopup() {
    var sharePopup = document.getElementById('sharePopup');
    sharePopup.style.display = (sharePopup.style.display === 'none' || sharePopup.style.display === '') ? 'block' : 'none';
}

  

    function shareWithCustomEmail() {
    // Prompt for email address
    var to = prompt("Enter recipient's email address:");

    if (to === null) {
        // User clicked Cancel
        return;
    }

    // Prompt for subject
    var subject = "Your Debit Note invoice details";

    // Prompt for message
    var message = `Dear,\nThanks for doing business with us. Below are your invoice details.\nAmount: 336\nBalance: 336\nTotal Balance: -2352\n\nThanks & Regards`;

    // Create the mailto link
    var mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;

    // Opening the link in a new tab
    window.open(mailtoLink, '_blank');
}


function shareWithWhatsApp() {
  // Add your logic for sharing with WhatsApp here

  // Replace '1234567890' with the recipient's phone number (include the country code)
  var phoneNumber = '1234567890';

  // Replace 'Hello, this is the message!' with your predefined message
  var message = encodeURIComponent('Hello, this is the message!');

  // Creating the WhatsApp link
  var whatsappLink = `https://wa.me/${phoneNumber}?text=${message}`;

  // Opening the link in a new tab
  window.open(whatsappLink, '_blank');
}


    function closePopup() {
    var sharePopup = document.getElementById('sharePopup');
    sharePopup.style.display = 'none';
}
  </script>

<script>
    
    // Define a function to clear the "To Date" input field
    function clearToDateInput() {
        document.getElementById("toDate").value = "";
        document.getElementById("fromDate").value = "";
    }

    // Attach the clearToDateInput function to the window.onload event
    window.onload = function() {
        clearToDateInput(); // Call the function to clear the "To Date" input field when the page loads
    };
      // Function to update the minimum date for the "To Date" input field based on the selected "From Date"
      function updateToDateMin() {
        // Get the value of the "From Date" input field
        var fromDateValue = document.getElementById("fromDate").value;

        // Set the minimum date for the "To Date" input field to the selected "From Date"
        document.getElementById("toDate").min = fromDateValue;

        // Get the value of the "To Date" input field
        var toDateValue = document.getElementById("toDate").value;

        // Check if the "From Date" is empty or null
        if (!fromDateValue) {
            // If "From Date" is empty, clear the "To Date" input field
            document.getElementById("toDate").value = "";
        } else if (fromDateValue && toDateValue) {
            // If both "From Date" and "To Date" are selected, call a function to fetch and display data based on the selected date range
            fetchDataFromToDate(fromDateValue, toDateValue);
        }
    }
</script>

<script>
    document.getElementById('ellipsisMenu').addEventListener('click', function (event) {
        const ellipsisIcon = event.target.closest('.ellipsis-menu i');
        if (ellipsisIcon) {
            const menuOptions = ellipsisIcon.nextElementSibling;
            menuOptions.style.display = (menuOptions.style.display === 'none' || menuOptions.style.display === '') ? 'block' : 'none';
        }
    });

    document.addEventListener('click', function (event) {
        const ellipsisMenu = document.getElementById('ellipsisMenu');
        if (!ellipsisMenu.contains(event.target)) {
            // Hide menu if click is outside the ellipsis menu
            document.querySelector('.menu-options').style.display = 'none';
        }
    });

    document.querySelector('.menu-options').addEventListener('click', function (event) {
        const menuOption = event.target.closest('.menu-option');
        if (menuOption) {
            const action = menuOption.getAttribute('data-action');
            handleAction(action);
            // Hide menu after an option is clicked
            this.style.display = 'none';
        }
    });

    function handleAction(action) {
        switch (action) {
            case 'view':
                viewAction();
                break;
            case 'edit':
                editAction();
                break;
            case 'history':
                historyAction();
                break;
            case 'viewPdf':
                viewPdfAction();
                break;
            case 'delete':
                deleteAction();
                break;
        }
    }

    function viewAction() {
        console.log('View action triggered');
    }

    function editAction() {
        console.log('Edit action triggered');
    }

    function historyAction() {
        console.log('History action triggered');
    }

    function viewPdfAction() {
        console.log('View PDF action triggered');
    }

   
</script>
<script>
   function deleteAction(debitNoteId) {
    // Get the CSRF token from a hidden input field
    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    // Send an AJAX request to delete the DebitNote object
    $.ajax({
        type: 'POST',
        url: '/delete_debit_note/',  
        data: {
            'debitnote_id': debitNoteId,
            'csrfmiddlewaretoken': csrfToken  // Include the retrieved CSRF token
        },
        success: function(response) {
            // Check if the deletion was successful
            if (response.status === 'success') {
                // Remove the deleted row from the table
                $('#debitNoteRow_' + debitNoteId).remove();
                // Optionally, show a success message
                alert('DebitNote deleted successfully.');
            } else {
                // Show an error message if the deletion failed
                alert('Failed to delete DebitNote.');
            }
        },
        error: function(xhr, status, error) {
            // Handle any errors that occur during the AJAX request
            console.error(xhr.responseText);
            alert('An error occurred while processing the request.');
        }
    });
}
</script>
</div>
{% endblock %}