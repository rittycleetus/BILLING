{% extends 'base.html' %}
{% load static %}
{% block content %}
<head>
 <!-- Include Select2 CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" integrity="sha384-GLhlTQ8iM4jQqR8r+cktRTt8Zp1eklHfEAg/8mtP1wwj1z9EGg6S5q6Z1PI5piJ6" crossorigin="anonymous">

<!-- Include jQuery (Select2 requires it) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-/KJ5oZqUeaOr5b+6S6Zkzep5l+M5R2T/W8C86gN7rqlTzq/WW6C+0cu1hKj2ktWZ" crossorigin="anonymous"></script>

<!-- Include Select2 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js" integrity="sha384-GLhlTQ8iM4jQqR8r+cktRTt8Zp1eklHfEAg/8mtP1wwj1z9EGg6S5q6Z1PI5piJ6" crossorigin="anonymous"></script>

<style>
        .new-row {
        background-color: #FFADB0; /* Your desired background color */
    }

    /* Hover styles for new rows */
    .new-row:hover {
        background-color: #E09497; /* Your desired hover background color */
    }

      select.form-control {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        text-indent: 1px;
        text-overflow: '';
    }

    /* Style the custom dropdown arrow */
    select.form-control::-ms-expand {
        display: none;
    }

    /* Use a background image as the custom arrow */

    .form-control {
        border: 2px solid #FFD6D7;
        transition: border-color 0.3s;
    }

    .form-control:focus {
        border-color: #ffffff;
    }

    #toPayRadio {
        accent-color: red;
    }

    #toReceiveRadio {
        accent-color: green;
    }


    .switch {
        position: relative;
        display: inline-block;
        width: 38px;
        height: 22px;
    }

  
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 13px;
        width: 13px;
        left: 3px;
        bottom: 5px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
    }

    input:checked+.slider {
        background-color: #2196F3;
    }

    input:focus+.slider {
        box-shadow: 0 0 1px #2196F3;
    }

    input:checked+.slider:before {
        -webkit-transform: translateX(26px);
        -ms-transform: translateX(26px);
        transform: translateX(18px);
    }

    .custom-width {
    width: 300px !important;
    /* Add other styles as needed */
  }
    .slider.round {
        border-radius: 34px;
    }

    .slider.round:before {
        border-radius: 50%;
    }

    .save-button {
        background-color: #007bff;
        border-color: #007bff; 
        color: #fff; 
        margin-right: 1rem;
    }

    td{
    border-right: 1px solid rgb(12, 12, 12);
  }
  th{
    width: 300px;
  }

  tbody:hover td:not(:last-child){
    border-right: 1px solid #68020F;
  }
    .save-button:hover {
        background-color: #fff;
        color: #007bff;
    }
    input{
    background-color: black;
    color: white;
  }

  .bs {
    box-shadow: 2px 2px 10px 3px rgba(0, 0, 0, 0.397);
  }

  .bs_sm {
    box-shadow: inset 2px 2px 5px 3px rgba(0, 0, 0, 0.199);
  }

  .tb {
    color: black;
  }

  .tg {
    color: rgb(0, 140, 7);
  }

  .tr {
    color: rgb(218, 0, 0);
  }

  .btn_add {
    background-color: orange;
    color: black;
  }

  .btn_add:hover {
    background-color: rgb(234, 152, 0);
    color: black;
  }

  ::-webkit-scrollbar {
    display: none
  }
  select option:hover{
    background-color: black;
  }

  input[type="radio"]:checked{
    accent-color: #68020F;
  }

  .input_border{
    border: 1px solid #68020F;
  }

  .button_border{
    border: 1px solid #68020F;
    color: #68020F;
  }

  .button_border:hover{
    background-color:#68020F;
    color: white;
  }
</style>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>

<div class="body-wrapper">

    <div class="container-fluid">
        <form action="#" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <h1 class="mb-4">DEBIT NOTE</h1>
     
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div style="border: 1px solid #000; padding: 10px; margin: 10px 0; background-color: #f8f9fa; color: #000; {% if message.tags == 'success' %}background-color: #d4edda; border-color: #c3e6cb; color: #155724;{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
            <div class="row">

                <div class="col-md-6">
                    <!-- Left side of the form -->

                  
                    <div class="form-group">
                        <label for="party">Party</label>
                        <div class="input-group">
                            <select name="party" id="party" class="form-control" style="width: 450px" onchange="handlePartySelection()">
                                <option value="">-- Select/Search Party --</option>
                                {% for party in parties %}
                                <option value="{{ party.id }}" 
                                    data-contact="{{ party.contact }}" 
                                    data-address="{{ party.address }}" 
                                    data-openingbalance="{{ party.openingbalance }}"
                                    data-billno="{{ party.bill.billno }}"
                                    data-billdate="{{ party.bill.billdate }}">
                                    {{ party.party_name }}
                                </option>
                            {% endfor %}
                        </select>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" style="background-color: maroon;" data-toggle="modal" data-target="#createPartyModal">+</button>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="form-group">
                        <label for="available_balance">Available Balance</label>
                        <input type="text" class="form-control" value="{% if selected_party %}{{ selected_party.openingbalance }}{% endif %}" readonly id="available_balance">
                    </div>
                    <br>
                    <div class="form-group">
                        <label for="contact_number">Contact Number</label>
                        <input type="text" class="form-control" value="{% if selected_party %}{{ selected_party.contact }}{% endif %}" readonly id="contact_number">
                    </div>
                    <br>
                    <div class="form-group" id="addressSection" style="display: none;">
                        <label for="address">Address</label>
                        <textarea class="form-control" readonly id="address">{% if selected_party %}{{ selected_party.address }}{% endif %}</textarea>
                    </div>
                 
                </div>
                <div class="col-md-6">
                    <!-- Right side of the form -->
                    <div class="form-group">
                        <label for="return_no">Return No.</label>
                        <input type="text" class="form-control" id="return_no" name="return_no" value="" >
                        <span id="return-no-message" style="color: red;"></span>
                    </div>
              
                
                    <br>
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" class="form-control" id="current-date" value="">
                    </div>
                    <br>
                    <!-- <div class="form-group">
                        <label for="bill">Select Bill:</label>
                        <select id="bill" name="bill">
                            {% for bill in bills %}
                                <option value="{{ bill.id }}">{{ bill.bill_no }} - {{ bill.billdate }}</option>
                            {% endfor %}
                        </select>
                    </div> -->
                    <div class="form-group">
                        <label for="bill">Select Bill</label>
                        <select id="bill" name="bill" class="form-control">
                            <option value="" disabled selected>NIL</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="billdate">Bill Date</label>
                        <input type="text" class="form-control" id="bill_date" value="NIL" disabled style="background-color: white;">
                    </div>
                    
                    
                </div>
                </div>
                <br><br><br>
                <div style="overflow-x:auto;">  
                    <table class="table table-hover  mt-5 " style="background-color: white;box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
                        <thead style="background: #68020F;">
                          <tr class="text-center text-light">
                            <th scope="col"class="custom-width" style="border-right: 1px solid;"><b>#</b></th>
                            <th scope="col" style="border-right: 1px solid;width: 310px;"><b>PRODUCT</b></th>
                            <th scope="col" style="border-right: 1px solid;width: 310px;"><b>HSN</b></th>
                            <th scope="col" style="border-right: 1px solid;"><b>QUANTITY</b></th>
                            <th scope="col" style="border-right: 1px solid;"><b>PRICE</b></th>
                            <th scope="col" style="border-right: 1px solid;"><b>TAX(%)</b></th>
                            <th scope="col" style="border-right: 1px solid;"><b>DISCOUNT</b></th>
                            <th scope="col" style="border-right: 1px solid;"><b>TOTAL</b></th>
                            <th scope="col" ><b>ACTION</th>
                            </tr>
                        </thead>
                     
                   
                        <tr style="background-color: #FFADB0;">
                            <td style="color: black;">1</td>
                            <td style="width: 990px;">
                                <div style="display: flex; position: relative;">
                                    <select name="selected_item[]" onchange="fillItemDetails1(this)" style="width: 130px;" class="form-control select2" id="select1">
                                        <option value="">-Select-</option>
                                        {% for item in items %}
                                            <option value="{{ item.id }}" data-hsn="{{ item.itm_hsn }}" data-price="{{ item.itm_purchase_price }}"  data-tax="VAT {{ item.itm_vat|floatformat:0 }}%" data-tax-rate="{{ item.get_vat_integer }}">{{ item.itm_name }}</option>
                                        {% endfor %}
                                    </select>
                            
                        &nbsp;&nbsp; &nbsp;&nbsp;                        &nbsp;&nbsp; &nbsp;&nbsp;
                                    <!-- "+" button -->
                                    <a href="{% url 'item_create1' %}" class="btn btn-outline-secondary" style="background-color: maroon; height: 40px; width: 30px; text-align: center; padding: 2px; position: absolute; right: 0;font-size: 20px;margin-left: 280px;"><b>+</b></a>
                                </div>
                            </td>
                            <td><span id="hsn" class="form-control" style="height: 40px; width: 90px;"></span></td>
                            <td><input type="number" name="item_quantity[]" style="width: 90px;" class="form-control" value="0" oninput="updateTotalAmount1(this)" required></td>
                            <td><span id="purchasePrice" style="width: 90px; height: 40px;" class="form-control"></span></td>
                            <td><span id="vat" style="width: 90px; height: 40px;" class="form-control"></span></td>
                            <td><input type="number" name="item_discount[]" class="form-control" style="width: 90px;" value="0" oninput="updateTotalAmount1(this)"></td>
                            <td><input type="number" name="item_total_amount[]" readonly class="form-control" style="width: 100px;" value="0"></td>
                        <td><i class="fas fa-trash-alt fa-lg delete-row"  style="margin-left: 10px;"></i></td>
                     
                     
                    </tbody>
                    </table>
                    <!-- + button to add a new row -->
                    <button type="button" onclick="addRow()" class="btn btn-outline-secondary" style="background-color: maroon; height: 40px; width: 45px; text-align: center; padding: 2px;font-size: 20px;"><b>+</b></button>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row">
                    <!-- Left side for Payment Type -->
                    <div class="col-md-4">
                        <label for="paymentType">Payment Type</label>
                        <select id="paymentType" name="paymentType" class="form-control">
                            <option value="">Select Payment Type</option>
                            <option value="cash">Cash</option>
                            <option value="cheque">Cheque</option>
                            <option value="upi">UPI</option>
                        </select>
                    </div>
            
                    
                    <!-- Right side for Input Details -->
                    <div class="col-md-6" style="margin-left: 170px;"  class="form-control">
                        <div class="container-fluid border p-3">
                            <!-- Subtotal Input -->
                            <div class="form-group row">
                                <label for="subtotal" class="col-sm-4 col-form-label">Subtotal</label>
                                <div class="col-sm-8">
                                    <input type="text" id="subtotal" name="subtotal" class="form-control" readonly>
                                </div>
                            </div>
                    
                            <!-- Tax Amount Input -->
                            <div class="form-group row">
                                <label for="taxAmount" class="col-sm-4 col-form-label">Tax Amount</label>
                                <div class="col-sm-8">
                                    <input type="text" id="taxAmount" name="taxAmount" class="form-control" readonly>
                                </div>
                            </div>
                    
                            <div class="form-group row">
                                <label for="adjustment" class="col-sm-4 col-form-label">Adjustment</label>
                                <div class="col-sm-8">
                                    <input type="text" id="adjustment" name="adjustment" class="form-control" value="0.00">
                                </div>
                            </div>
                    
                            <!-- Grand Total Input -->
                            <div class="form-group row">
                                <label for="grandTotal" class="col-sm-4 col-form-label">Grand Total</label>
                                <div class="col-sm-8">
                                    <input type="text" id="grandTotal" name="grandTotal" class="form-control" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    <p>Item VAT: {{ item.itm_vat }}</p>

<!-- Display the extracted tax rate -->
<p>Extracted Tax Rate: {{ taxRate }}</p>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
</div>



<div class="modal" id="createPartyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 1200px;height: 300px;">
        <div class="modal-content" style="background-color: #FFD6D7;">
            <div class="modal-header">
                <h2 class="modal-title" style="font-size: 2.5rem;"><b>Create New Party</b></h2>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Form for creating a new party -->
                <form method="POST" action="{% url 'create_party' %}" class="p-10" enctype="multipart/form-data" novalidate
                id="forms" >
                {% csrf_token %}
                <div class="body-wrapper">
                    <div class="container-fluid">
                        <div class="col-md-3">
                            <a class="text-dark" style="font-size: 1.5rem;">Add New Party</a>
                        </div>
                        <div class="col-md-9 row" style="margin-top: 3vw;">
                            <div class="col-md-4">
                                <input type="text" style="background-color: white;" class="form-control" id="partyname" name="partyname" placeholder="Party Name" required>
                            </div>                
                            <div class="col-md-4" style="position: relative;">
                                <input type="text" style="background-color: white;" class="form-control" id="trn_no" name="trn_no" placeholder="TRN NO" oninput="validateGSTIN(this)">
                                <span id="gstno-validation" style="position: absolute; right: 14px; top: 8px;"></span>
                                <label style="color: rgb(101, 3, 3);">* 32AAQFR1222B1ZS</label>
                            </div>
                            
                            <div class="col-md-4" style="position: relative;">
                                <input required type="number" style="background-color: white;" class="form-control" id="contact" pattern="[0-9]{10}" name="contact" placeholder="Phone Number" oninput="validatePhoneNumber(this)">
                                <span id="contact-validation" style="position: absolute; right: 15px; top: 8px;"></span>
                            </div>  
                            
                            
                            <div class="options" style="margin-top: 5vw;">
                                <a href="javascript:void(0);" onclick="toggleSection('GST')" style="color: black;"><b>GST &
                                        Address<b></a>
                                <a href="javascript:void(0);" onclick="toggleSection('Credit')"
                                    style="color: black; margin-left: 3vw;"><b>Credit & Balances<b></a>
                                <a href="javascript:void(0);" onclick="toggleSection('additionalfield')"
                                    style="color: black; margin-left: 3vw;">Additional Fields</a>
                            </div>
                        </div>
                        <fieldset id="GST" class="GST">
                            <div style="background-color: white;" class="col-sm-5"><select class="form-control mt-4 " id="trn_type" name="trn_type">
                                    <option disabled selected>Select TRN Type</option>
                                    <option >Unregistered/Consumers</option>
                                    <option>Registered Business - Regular</option>
                                    <option>Registered Business - Composition</option>
                                </select>
                            </div>
                            <div class="col-sm-5 ">
                                <textarea style="background-color: white;" class="form-control mt-4" name="address" id="" cols="56" rows="3"
                                    placeholder="&nbsp;Address"></textarea>
                            </div>
                    
                            <div class="col-sm-5 ">
                                <input style="background-color: white;" type="text" class="form-control mt-4" id="state" name="state" placeholder="State">
                            </div> 
                            
            
                    
                    <div class="col-sm-5 ">
                        <input style="background-color: white;" type="email" class="form-control mt-4" id="email" name="email" placeholder="Email">
                    </div>
                    </fieldset>
            
                    <fieldset id="Credit" class="Credit" style="display:none;">
                        <div class="col-sm-5">
                            <input style="background-color: white;" type="number" class="form-control mt-4" id="balance" name="balance" placeholder="Opening Balance">
                        </div>
                    
                        <div  class="col-sm-7 mt-4">
                            <label class="radio-label">To Pay</label>
                            <input type="radio" class="radio-input" id="toPayRadio" name="paymentType" value="To Pay" style="margin-right: 2vw; margin-left: 5px;">
                            <label class="radio-label">To Receive</label>
                            <input type="radio" class="radio-input" id="toReceiveRadio" name="paymentType" value="To Receive" style="margin-right: 2vw; margin-left: 5px;">
                        </div>
                    
                       
                    
                        <div class="col-md-5 mt-4">
                            <input type="date" class="form-control" id="current-date1" name="currentdate" placeholder="Current Date" style="background-color: white;">
                        </div>
                    
            
                    </fieldset>
                    
                    <fieldset id="additionalfield" class="additionalfield" style="display:none;">
                        <div class="col-md-5 mt-4">
                            <input type="text" class="form-control" name="additionalfield1" id="additionalfield1" placeholder="Additional Field" style="background-color: white;">
                        </div>
                
                        <div class="col-md-5 mt-4">
                            <input type="text" class="form-control" name="additionalfield2" id="additionalfield2" placeholder="Additional Field" style="background-color: white;">
                        </div>
                
                        <div class="col-md-5 mt-4">
                            <input type="text" class="form-control" name="additionalfield3" id="additionalfield3" placeholder="Additional Field" style="background-color: white;">
                        </div>
                    </fieldset>
            
                   
                    <div class="col-md-5 mt-4">
                        <input type="submit" class="btn btn-primary save-button" name="save_and_new" value="Save&New">
                        <input type="submit" class="btn btn-primary save-button" name="save" value="Save">
                    </div>
            
                </div>
                </form>
                </div>
                


          












                <script>
                    function toggleSection(sectionId) {
                        // Get all the fieldsets
                        const fieldsets = document.querySelectorAll('fieldset');
            
                        // Hide all fieldsets
                        fieldsets.forEach(fieldset => {
                            fieldset.style.display = 'none';
                        });
            
                        // Show the selected fieldset
                        const section = document.getElementById(sectionId);
                        if (section.style.display === 'none') {
                            section.style.display = 'block';
                        } else {
                            section.style.display = 'none';
                        }
                    }
            
            
                // Function to format the date as "YYYY-MM-DD"
                function formatDate(date) {
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            
             
    // Get the current date
    let currentDate = new Date();

    // Format the date to 'YYYY-MM-DD'
    let formattedDate = currentDate.toISOString().split('T')[0];

    // Set the formatted date as the default value for the input field
    document.getElementById('current-date1').value = formattedDate;
  
            function validatePhoneNumber(inputElement) {
                const phoneNumber = inputElement.value;
                const validationSpan = document.getElementById("contact-validation");
            
                // Regular expression to check for a 10-digit number
                const regex = /^[0-9]{10}$/;
            
                if (regex.test(phoneNumber)) {
                    // Valid 10-digit number, display a checkmark
                    validationSpan.innerHTML = "&#10004;"; // Checkmark symbol
                    validationSpan.style.color = "green";
                } else {
                    // Not a valid 10-digit number, display a cross mark
                    validationSpan.innerHTML = "&#10060;"; // Cross mark symbol
                    validationSpan.style.color = "red";
                }
            }
            
            function validateGSTIN(inputElement) {
                const gstin = inputElement.value;
                const validationSpan = document.getElementById("gstno-validation");
            
                // Regular expression to check for a valid GSTIN pattern
                const regex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z][0-9][A-Z][A-Z0-9]$/;
            
                if (regex.test(gstin)) {
                    // Valid GSTIN format, display a checkmark
                    validationSpan.innerHTML = "&#10004;"; // Checkmark symbol
                    validationSpan.style.color = "green";
                } else {
                    // Not a valid GSTIN format, display a cross mark
                    validationSpan.innerHTML = "&#10060;"; // Cross mark symbol
                    validationSpan.style.color = "red";
                }
            }
            
            </script>
            <script>
                // Function to format the date as "YYYY-MM-DD"
                function formatDate(date) {
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            
                // Get the current date
                const currentDateInput = document.getElementById("current-date");
                currentDate = new Date();
            
                // Format the date as "YYYY-MM-DD" and set it in the input field
                currentDateInput.value = formatDate(currentDate);
            </script>
        <script>
            $(document).ready(function () {
                // Handle change event when a party is selected
                $('#party').change(function () {
                    // Get the selected party option
                    var selectedOption = $(this).find(':selected');
        
                    // Update the input fields with the data attributes of the selected party
                    $('#contact_number').val(selectedOption.data('contact'));
                    $('#address').val(selectedOption.data('address'));
                    $('#available_balance').val(selectedOption.data('openingbalance'));
                });
            });
        </script>
        <script>
            
    // Function to format the date as "YYYY-MM-DD"
    function formatDate(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

            const currentDateInput = document.getElementById("current-date");
            currentDate = new Date();
        
            // Format the date as "YYYY-MM-DD" and set it in the input field
            currentDateInput.value = formatDate(currentDate);
        </script>
            
       </div>
   </div>

<script>
    $(document).ready(function () {
        // Get the initial pattern
        var initialPattern = /^JK\d+$/i;

        // Listen for changes in the "Return No." field
        $('#return_no').change(function () {
            // Get the entered return number
            var returnNo = $(this).val();

            // Check if the pattern is followed (e.g., JK1, JK2, JK3, ...)
            if (!initialPattern.test(returnNo)) {
                // Display a confirmation message
                var confirmed = confirm('Changing the pattern will reset the return number. Are you sure you want to change the pattern?');

                if (!confirmed) {
                    // Revert to the previous value
                    $(this).val('');
                    return;
                }

                // Update the initial pattern if confirmed
                initialPattern = new RegExp("^" + returnNo + "$", "i");
            }

            // Check if the pattern is followed (e.g., JK1, JK2, JK3, ...)
            if (!initialPattern.test(returnNo)) {
                // Display an error message
                $('#return-no-message').text('Return No. should follow the pattern JK1, JK2, JK3, ...');
            } else {
                // Clear the error message
                $('#return-no-message').text('');

                // You can perform additional logic if needed
            }
        });

        // Automatically generate and set the initial return number on form load
        var lastReturnNo = getLastReturnNo(); // You need to implement this function
        var newReturnNo = generateNextReturnNo(lastReturnNo);
        $('#return_no').val(newReturnNo);
    });

    // Function to get the last return number from the database or any other source
    function getLastReturnNo() {
        // Implement logic to get the last return number
        // For now, let's assume it returns the last stored return number
        return "JK2";
    }

    // Function to generate the next return number based on the last return number
    function generateNextReturnNo(lastReturnNo) {
        var match = lastReturnNo.match(/(\D+)(\d+)/);
        var prefix = match[1];
        var number = parseInt(match[2]);
        return prefix + (number + 1);
    }
</script>
<script>
    $('#party').change(function () {
            // Get the selected party option
            var selectedOption = $(this).find(':selected');

            // Check if the selected party has an associated bill
            if (selectedOption.val() !== '' && selectedOption.text() !== 'No bills available for the selected party.') {
                // Get the bill number and date from the selected option's data attributes
                var billNumber = selectedOption.data('billno');
                var billDate = selectedOption.data('billdate');

                // Autofill the bill number and date fields
                $('#bill').val(billNumber);
                $('#bill_date').val(billDate);
            } else {
                // Clear the fields if no associated bill
                $('#bill').val('');
                $('#bill_date').val('NIL');
            }
        });
  
</script>

<script>
    $(document).ready(function() {
        $('#party').select2({
            width: '450px',
            placeholder: '-- Select/Search Party --',
            allowClear: true // Adds a clear button to the dropdown
        });
    });
</script>
<script>
     function handlePartySelection() {
        var partySelect = document.getElementById("party");
        var selectedOption = partySelect.options[partySelect.selectedIndex];
        var addressSection = document.getElementById("addressSection");

        // Check if the selected party has an address
        var address = selectedOption.getAttribute("data-address");
        if (address && address !== "none") {
            // Display the address section
            addressSection.style.display = "block";
        } else {
            // Hide the address section
            addressSection.style.display = "none";
        }
    }

    // Trigger handlePartySelection on page load to handle default selection
    document.addEventListener("DOMContentLoaded", function() {
        handlePartySelection();
    });
</script>
<script>
    function fillItemDetails1(selectElement) {
        // Get the selected option
        var selectedOption = selectElement.options[selectElement.selectedIndex];

        // Get the associated details
        var hsn = selectedOption.getAttribute("data-hsn") || "";
        var purchasePrice = selectedOption.getAttribute("data-price") || "";
        var vat = selectedOption.getAttribute("data-tax") || "";

        // Update the elements in the current row with the details
        var row = selectElement.closest('tr');
        row.querySelector('span[id="hsn"]').textContent = hsn;
        row.querySelector('span[id="purchasePrice"]').textContent = purchasePrice;
        row.querySelector('span[id="vat"]').textContent = vat;

        // ... (any additional updates you need)
    }
    function updateTotalAmount1(inputElement) {
    // Get the parent row
    var row = inputElement.closest('tr');

    // Get the quantity, price, and discount values
    var quantity = parseFloat(row.querySelector('[name="item_quantity[]"]').value) || 0;
    var price = parseFloat(row.querySelector('#purchasePrice').innerText) || 0;
    var discount = parseFloat(row.querySelector('[name="item_discount[]"]').value) || 0;

    // Calculate the total amount
    var totalAmount = (quantity * price) - discount;

    // Update the total amount input field
    row.querySelector('[name="item_total_amount[]"]').value = totalAmount.toFixed(2);

    updateSubtotal(); // Call the function to update Subtotal

}

// Add event listener to Adjustment input for dynamic updating
document.getElementById('adjustment').addEventListener('input', function () {
    updateTotals(); // Call the function to update Grand Total and Tax Amount
    updateSubtotal(); // Call the function to update Subtotal
    
});

    // Function to set default values when the page loads
    window.onload = function () {
    // Get all quantity, discount, and total amount input fields
    var quantityFields = document.querySelectorAll('[name="item_quantity[]"]');
    var discountFields = document.querySelectorAll('[name="item_discount[]"]');
    var totalAmountFields = document.querySelectorAll('[name="item_total_amount[]"]');

    // Set default values to 0
    quantityFields.forEach(function (element) {
        element.value = 0;
    });

    discountFields.forEach(function (element) {
        element.value = 0;
    });

    totalAmountFields.forEach(function (element) {
        element.value = 0;
    });

    // Set other default values or call additional initialization functions if needed
    document.getElementById('grandTotal').value = '0.00';
    document.getElementById('taxAmount').value = 0.00;
    document.getElementById('adjustment').value = '0.00';
    // Call the function to calculate tax amount and update other fields
    
    updateSubtotal();
    updateTotals();

    console.log("Page Loaded");
}
</script>
<script>
    // Initialize select2 after the page loads
    $(document).ready(function() {
        $('#select1').select2({
            placeholder: 'Another Select Product',
            allowClear: true,
            width: '100%',
        });
        $('.#select1').val(null).trigger('change');


    });
</script>
<script>
    function addRow() {
        // Get the table body
        var tableBody = document.querySelector('.table tbody');

        // Create a new row
        var newRow = tableBody.insertRow();
        newRow.classList.add('new-row')

        
        // Cell 1: Counter
        var cell1 = newRow.insertCell(0);
        cell1.innerHTML = tableBody.rows.length; // Set the row number

        // Cell 2: Product Dropdown
        var cell2 = newRow.insertCell(1);
        cell2.innerHTML = '<div style="display: flex; position: relative;">' +
            '<select name="selected_item[]" onchange="fillItemDetails(this, this.parentNode.parentNode)" style="width: 120px;" class="form-control select2" id="select1">' +
            '<option value="">-Select-</option>' +
            '{% for item in items %}' +
            '<option value="{{ item.id }}" data-hsn="{{ item.itm_hsn }}" data-price="{{ item.itm_purchase_price }}" data-tax="VAT {{ item.itm_vat|floatformat:0 }}%">{{ item.itm_name }}</option>' +
            '{% endfor %}' +
            '</select>' +
            '<a href="{% url 'item_create1' %}" class="btn btn-outline-secondary" style="background-color: maroon; height: 40px; width: 30px; text-align: center; padding: 2px; position: absolute; right: 0; font-size: 20px; margin-left: 280px;"><b>+</b></a>' +
            '</div>';

        // Cell 3: HSN
        var cell3 = newRow.insertCell(2);
        cell3.innerHTML = '<span id="hsn' + tableBody.rows.length + '" class="form-control" style="height: 40px; width: 90px;"></span>';

        // Cell 4: Quantity
        var cell4 = newRow.insertCell(3);
        cell4.innerHTML = '<input type="number" name="item_quantity[]" style="width: 90px;" class="form-control" value="0" oninput="updateTotalAmount(this)" required>';

        // Cell 5: Purchase Price
        var cell5 = newRow.insertCell(4);
        cell5.innerHTML = '<span id="purchasePrice' + tableBody.rows.length + '" style="width: 90px; height: 40px;" class="form-control"></span>';

        // Cell 6: VAT
        var cell6 = newRow.insertCell(5);
        cell6.innerHTML = '<span id="vat' + tableBody.rows.length + '" style="width: 90px; height: 40px;" class="form-control"></span>';

        // Cell 7: Discount
        var cell7 = newRow.insertCell(6);
        cell7.innerHTML = '<input type="number" name="item_discount[]" class="form-control" style="width: 90px;" value="0" oninput="updateTotalAmount(this)">';

        // Cell 8: Total Amount
        var cell8 = newRow.insertCell(7);
        cell8.innerHTML = '<input type="number" name="item_total_amount[]" readonly class="form-control" style="width: 100px;" value="0">';

        var cell9 = newRow.insertCell(8);
        cell9.innerHTML = '<i class="fas fa-trash-alt fa-lg delete-row" style="margin-left: 10px;"></i>';

        // Add an event listener to the new product dropdown for dynamic updates
        var newSelect = cell2.querySelector('select[name="selected_item[]"]');
        newSelect.addEventListener('change', function() {
            fillItemDetails(newSelect, newRow);
        });
                // Add an event listener to the new discount input for dynamic updating
        var newDiscountInput = cell7.querySelector('[name="item_discount[]"]');
        newDiscountInput.addEventListener('input', function () {
        updateTotalAmount1(newDiscountInput);
        updateSubtotal();
    });


// Add event listener to Adjustment input for dynamic updating
        document.getElementById('adjustment').addEventListener('input', function () {
         updateTotals(); // Call the function to update Grand Total and Tax Amount
         updateSubtotal(); // Call the function to update Subtotal


        });

        // Increment IDs and update the new row
        updateRowIds(newRow);
        updateTotalAmount1(document.getElementById('adjustment'));
        updateSubtotal();
    }

    // Function to increment IDs and update the new row
    
    function updateRowIds(row) {
        var rowCount = document.querySelectorAll('.table tbody tr').length;

        // Update IDs for the new row
        row.querySelector('span[id^="hsn"]').id = 'hsn' + rowCount;
        row.querySelector('span[id^="purchasePrice"]').id = 'purchasePrice' + rowCount;
        row.querySelector('span[id^="vat"]').id = 'vat' + rowCount;
        row.classList.add('new-row');

        // Call the function to update Subtotal
        updateSubtotal();

    }

    function fillItemDetails(selectElement, row) {
        // Get the selected option
        var selectedOption = selectElement.options[selectElement.selectedIndex];

        // Get the associated details
        var hsn = selectedOption.getAttribute("data-hsn") || "";
        var purchasePrice = selectedOption.getAttribute("data-price") || "";
        var vat = selectedOption.getAttribute("data-tax") || "";

        // Update the elements in the current row with the details
        row.querySelector('span[id^="hsn"]').textContent = hsn;
        row.querySelector('span[id^="purchasePrice"]').textContent = purchasePrice;
        row.querySelector('span[id^="vat"]').textContent = vat;
        updateSubtotal();

        // ... (any additional updates you need)
    }

    function updateTotalAmount(inputElement) {
    // Get the parent row
    var row = inputElement.closest('tr');

    // Get the quantity, price, and discount values
    var quantity = parseFloat(row.querySelector('[name="item_quantity[]"]').value) || 0;
    var price = parseFloat(row.querySelector('#purchasePrice' + row.rowIndex).innerText) || 0;
    var discount = parseFloat(row.querySelector('[name="item_discount[]"]').value) || 0;

    // Calculate the total amount
    var totalAmount = (quantity * price) - discount;

    // Update the total amount input field
    row.querySelector('[name="item_total_amount[]"]').value = totalAmount.toFixed(2);

    // Call the updateSubtotal function after updating total amounts
    updateSubtotal();
}

// Function to set default values when the page loads
window.onload = function () {
    // Get all quantity, discount, and total amount input fields
    var quantityFields = document.querySelectorAll('[name="item_quantity[]"]');
    var discountFields = document.querySelectorAll('[name="item_discount[]"]');
    var totalAmountFields = document.querySelectorAll('[name="item_total_amount[]"]');

    // Set default values to 0
    quantityFields.forEach(function (element) {
        element.value = 0;
    });

    discountFields.forEach(function (element) {
        element.value = 0;
    });

    totalAmountFields.forEach(function (element) {
        element.value = 0;
    });
};
</script>
<script>
    $(document).ready(function () {
        // Delete row when delete icon is clicked
        $(document).on('click', '.delete-row', function () {
            // Find the closest 'tr' (table row) and remove it
            $(this).closest('tr').remove();
        });
    });
</script>
<script>
function updateSubtotal() {
    var totalElements = document.querySelectorAll('[name="item_total_amount[]"]');
    var subtotal = 0;
    

    // Iterate through each row and add up the total amounts
    totalElements.forEach(function (element) {
        subtotal += parseFloat(element.value) || 0;
    });

    document.getElementById('subtotal').value = subtotal.toFixed(2);
    updateTotals(); 
    
    updateGrandTotal();
    calculateTaxAmount();

}


window.onload = function () {
    // Get all quantity, discount, and total amount input fields
    var quantityFields = document.querySelectorAll('[name="item_quantity[]"]');
    var discountFields = document.querySelectorAll('[name="item_discount[]"]');
    var totalAmountFields = document.querySelectorAll('[name="item_total_amount[]"]');
   

    // Set default values to 0
    quantityFields.forEach(function (element) {
        element.value = 0;
    });

    discountFields.forEach(function (element) {
        element.value = 0;
    });

    totalAmountFields.forEach(function (element) {
        element.value = 0;
    });

 
    // Initialize Grand Total and Tax Amount to 0
    document.getElementById('grandTotal').value = '0.00';
    document.getElementById('taxAmount').value = 0;
    document.getElementById('adjustment').value = '0.00';

    // Calculate Subtotal and update totals
    
    updateSubtotal();
    updateTotals();
    calculateTaxAmount
};
</script>
<script>
    function calculateTaxAmount() {
    var taxElements = document.querySelectorAll('[name="item_vat[]"]');
    var taxAmount = 0;

    taxElements.forEach(function (element) {
        var row = element.closest('tr');
        var quantity = parseFloat(row.querySelector('[name="item_quantity[]"]').value) || 0;
        var price = parseFloat(row.querySelector('#purchasePrice').innerText) || 0;
        var discount = parseFloat(row.querySelector('[name="item_discount[]"]').value) || 0;
        var taxRateData = element.getAttribute("data-tax-rate");
        
        // Extract numeric tax rate from data attribute
        var taxRate = parseFloat(taxRateData.split(' ')[1].replace('%', '')) || 0;

        // Calculate tax for the row
        var taxForRow = (quantity * price - discount) * (taxRate / 100);
        taxAmount += taxForRow;
    });

    // Display tax amount in console
    console.log('Total Tax Amount:', taxAmount);

    // Update tax amount in the corresponding input field
    document.getElementById('taxAmount').value = taxAmount.toFixed(2);

    // Trigger other calculations if needed (e.g., updateGrandTotal())
    updateGrandTotal();
}
</script>
<script>

function updateGrandTotal() {
    var subtotal = parseFloat(document.getElementById('subtotal').value) || 0;
    var taxAmount = parseFloat(document.getElementById('taxAmount').value) || 0;
    var adjustment = parseFloat(document.getElementById('adjustment').value) || 0;
   

    // Calculate the Grand Total
    
    var grandTotal = subtotal + taxAmount + adjustment;

    // Update the Grand Total input field
    document.getElementById('grandTotal').value = grandTotal.toFixed(2);
    console.log("Grand Total:", grandTotal);
}

// Initialize values when the page loads
window.onload = function () {
    // Get all quantity, discount, and total amount input fields
    var quantityFields = document.querySelectorAll('[name="item_quantity[]"]');
    var discountFields = document.querySelectorAll('[name="item_discount[]"]');
    var totalAmountFields = document.querySelectorAll('[name="item_total_amount[]"]');

    // Set default values to 0
    quantityFields.forEach(function (element) {
        element.value = 0;
    });

    discountFields.forEach(function (element) {
        element.value = 0;
    });

    totalAmountFields.forEach(function (element) {
        element.value = 0;
    });

    // Set other default values or call additional initialization functions if needed
    document.getElementById('grandTotal').value = '0.00';
    document.getElementById('taxAmount').value = 0.00;
    document.getElementById('adjustment').value = '0.00';
    // Call the function to calculate tax amount and update other fields
   
    updateSubtotal();
    updateTotals();

    console.log("Page Loaded");
};
</script>
   </body>
            
{% endblock %}